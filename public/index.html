<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å«æ˜Ÿå½±åƒä¸‹è½½å™¨ | Satellite Imagery Downloader</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
        }

        header h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        header p {
            color: #8892b0;
            font-size: 1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .map-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #map {
            height: 450px;
            border-radius: 12px;
            z-index: 1;
        }

        .map-instructions {
            text-align: center;
            padding: 8px;
            color: #00d9ff;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .controls-section {
            margin-top: 20px;
        }

        .bbox-display {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 20px;
        }

        .bbox-display h4 {
            color: #00d9ff;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .bbox-coords {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #ccd6f6;
            line-height: 1.5;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #ccd6f6;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: #fff;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #00d9ff;
            background: rgba(255, 255, 255, 0.12);
        }

        .form-group select option {
            background: #1a1a2e;
            color: #fff;
        }

        .source-info {
            background: rgba(136, 146, 176, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-top: 8px;
            font-size: 0.8rem;
            color: #8892b0;
        }

        .source-info strong {
            color: #ccd6f6;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 150px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            color: #1a1a2e;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 217, 255, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .result-panel {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            display: none;
        }

        .result-panel.show {
            display: block;
        }

        .result-panel h3 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .command-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
        }

        .command-box code {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #00ff88;
            word-break: break-all;
            display: block;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: rgba(0, 217, 255, 0.3);
        }

        .info-list {
            list-style: none;
            margin: 15px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .info-list li {
            padding: 6px 0;
            color: #ccd6f6;
            font-size: 0.9rem;
        }

        .info-list strong {
            color: #00d9ff;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #8892b0;
            font-size: 0.9rem;
        }

        .footer a {
            color: #00d9ff;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.5rem;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ›°ï¸ å«æ˜Ÿå½±åƒä¸‹è½½å™¨</h1>
            <p>Satellite Imagery Downloader - Select area & download</p>
        </header>

        <div class="main-content">
            <div class="map-section">
                <div class="map-instructions">
                    ğŸ“ åœ¨åœ°å›¾ä¸Šç»˜åˆ¶çŸ©å½¢æ¡†é€‰ä¸‹è½½åŒºåŸŸ | Draw a rectangle to select area
                </div>
                <div id="map"></div>

                <div class="controls-section">
                    <div class="bbox-display">
                        <h4>ğŸ“ é€‰å®šåŒºåŸŸ | Selected Area</h4>
                        <div class="bbox-coords" id="bboxCoords">
                            è¯·åœ¨åœ°å›¾ä¸Šç»˜åˆ¶çŸ©å½¢é€‰æ‹©åŒºåŸŸ<br>
                            Please draw a rectangle on the map
                        </div>
                    </div>

                    <div class="controls-grid">
                        <div class="form-group">
                            <label for="sourceSelect">ğŸŒ æ•°æ®æº | Data Source</label>
                            <select id="sourceSelect">
                                <option value="esri" selected>Esri World Imagery (~1m) [æ¨è]</option>
                                <option value="sentinel2">Sentinel-2 (~10m) [æš‚ä¸å¯ç”¨]</option>
                                <option value="landsat">Landsat (~30m) [æš‚ä¸å¯ç”¨]</option>
                                <option value="modis">MODIS (~250m) [æš‚ä¸å¯ç”¨]</option>
                                <option value="osm">OpenStreetMap (Vector)</option>
                            </select>
                            <div class="source-info" id="sourceInfo"></div>
                        </div>

                        <div class="form-group">
                            <label for="zoomInput">ğŸ” ç¼©æ”¾çº§åˆ« | Zoom Level (å¯é€‰)</label>
                            <input type="number" id="zoomInput" min="1" max="19" placeholder="è‡ªåŠ¨é€‰æ‹© | Auto select">
                        </div>

                        <div class="form-group">
                            <label for="compressionSelect">ğŸ—œï¸ å‹ç¼©æ–¹å¼ | Compression</label>
                            <select id="compressionSelect">
                                <option value="lzw">LZW (æ¨è | Recommended)</option>
                                <option value="deflate">Deflate</option>
                                <option value="jpeg">JPEG (æœ‰æŸ | Lossy)</option>
                                <option value="none">None (æ— å‹ç¼© | No compression)</option>
                            </select>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" id="downloadBtn" disabled>
                            ğŸš€ æµè§ˆå™¨ç›´æ¥ä¸‹è½½ | Browser Download
                        </button>

                        <button class="btn btn-secondary" id="commandBtn" disabled>
                            ğŸ“‹ è·å–å‘½ä»¤è¡Œ | Get CLI Command
                        </button>

                        <button class="btn btn-secondary" id="clearBtn">
                            ğŸ—‘ï¸ æ¸…é™¤é€‰åŒº | Clear Selection
                        </button>
                    </div>

                    <div class="result-panel" id="resultPanel">
                        <h3 id="resultTitle">ğŸ“¥ ä¸‹è½½ä¸­... | Downloading...</h3>

                        <div id="downloadProgress" style="margin: 15px 0;">
                            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 20px; overflow: hidden;">
                                <div id="progressBar" style="background: linear-gradient(90deg, #00d9ff, #00ff88); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div style="text-align: center; margin-top: 8px; font-size: 0.9rem;">
                                <span id="progressText">å‡†å¤‡ä¸‹è½½...</span>
                            </div>
                        </div>

                        <div id="downloadComplete" style="display: none;">
                            <div class="command-box" id="imagePreviewBox" style="display: none; text-align: center;">
                                <img id="previewImage" style="max-width: 100%; border-radius: 8px; margin-bottom: 10px;">
                            </div>

                            <button class="btn btn-primary" id="saveImageBtn" style="margin-bottom: 15px;">
                                ğŸ’¾ ä¿å­˜å›¾ç‰‡ | Save Image
                            </button>

                            <div class="command-box" id="commandBox" style="display: none;">
                                <code id="commandOutput"></code>
                                <button class="copy-btn" id="copyBtn">å¤åˆ¶ | Copy</button>
                            </div>

                            <ul class="info-list">
                                <li><strong>æ•°æ®æº:</strong> <span id="resultSource"></span></li>
                                <li><strong>åŒºåŸŸ:</strong> <span id="resultArea"></span></li>
                                <li><strong>ç“¦ç‰‡æ•°:</strong> <span id="resultTiles"></span></li>
                                <li><strong>åˆ†è¾¨ç‡:</strong> <span id="resultResolution"></span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>
                æ•°æ®æ¥æº: ESA, NASA, USGS, Esri, OSM |
                <a href="https://github.com/jsy96/satellite-downloader" target="_blank">GitHub</a>
            </p>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        // Data sources configuration
        const DATA_SOURCES = {
            sentinel2: {
                id: 'sentinel2',
                name: 'Sentinel-2',
                resolution: '~10m per pixel',
                description: 'NASA GIBS service changed - currently not available',
                zoomLevels: [0, 13],
                maxCloudCover: 20,
                available: false
            },
            landsat: {
                id: 'landsat',
                name: 'Landsat',
                resolution: '~30m per pixel',
                description: 'NASA GIBS service changed - currently not available',
                zoomLevels: [0, 12],
                maxCloudCover: 100,
                available: false
            },
            modis: {
                id: 'modis',
                name: 'MODIS',
                resolution: '~250m per pixel',
                description: 'NASA GIBS service changed - currently not available',
                zoomLevels: [0, 9],
                maxCloudCover: 100,
                available: false
            },
            esri: {
                id: 'esri',
                name: 'Esri World Imagery',
                resolution: '~1m per pixel (variable)',
                description: 'High-resolution satellite and aerial imagery (recommended)',
                zoomLevels: [0, 17],
                maxCloudCover: 100,
                available: true
            },
            osm: {
                id: 'osm',
                name: 'OpenStreetMap',
                resolution: 'Vector rendering',
                description: 'OpenStreetMap (vector rendering, not real imagery)',
                zoomLevels: [0, 19],
                maxCloudCover: 100,
                available: true
            }
        };

        // Global state
        let map;
        let drawnItems;
        let currentBBox = null;
        let downloadedCanvas = null;
        let downloadedBlob = null;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.9042, 116.4074], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            const drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    polygon: false,
                    polyline: false,
                    circle: false,
                    circlemarker: false,
                    marker: false,
                    rectangle: {
                        shapeOptions: {
                            color: '#00d9ff',
                            weight: 2
                        }
                    }
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            map.addControl(drawControl);

            map.on(L.Draw.Event.CREATED, function (e) {
                drawnItems.clearLayers();
                const layer = e.layer;
                drawnItems.addLayer(layer);

                const bounds = layer.getBounds();
                currentBBox = {
                    min_lon: bounds.getWest(),
                    min_lat: bounds.getSouth(),
                    max_lon: bounds.getEast(),
                    max_lat: bounds.getNorth()
                };

                updateBBoxDisplay();
                updateDownloadButton();
            });

            map.on('draw:deleted', function () {
                currentBBox = null;
                updateBBoxDisplay();
                updateDownloadButton();
            });
        }

        function updateBBoxDisplay() {
            const display = document.getElementById('bboxCoords');
            if (currentBBox) {
                display.innerHTML = `
                    è¥¿: ${currentBBox.min_lon.toFixed(4)} | West<br>
                    å—: ${currentBBox.min_lat.toFixed(4)} | South<br>
                    ä¸œ: ${currentBBox.max_lon.toFixed(4)} | East<br>
                    åŒ—: ${currentBBox.max_lat.toFixed(4)} | North
                `;
            } else {
                display.innerHTML = 'è¯·åœ¨åœ°å›¾ä¸Šç»˜åˆ¶çŸ©å½¢é€‰æ‹©åŒºåŸŸ<br>Please draw a rectangle on the map';
            }
        }

        function updateDownloadButton() {
            const btn = document.getElementById('downloadBtn');
            const cmdBtn = document.getElementById('commandBtn');
            const disabled = !currentBBox;
            btn.disabled = disabled;
            cmdBtn.disabled = disabled;
        }

        function updateSourceInfo() {
            const select = document.getElementById('sourceSelect');
            const info = document.getElementById('sourceInfo');
            const source = DATA_SOURCES[select.value];

            if (source) {
                const availableStyle = source.available ? '' : 'style="color: #ff6b6b;"';
                info.innerHTML = `
                    <strong ${availableStyle}>æè¿°:</strong> ${source.description}<br>
                    <strong>ç¼©æ”¾çº§åˆ«:</strong> ${source.zoomLevels[0]} - ${source.zoomLevels[1]}
                    ${!source.available ? '<br><strong style="color: #ff6b6b;">âš ï¸ æš‚ä¸å¯ç”¨</strong>' : ''}
                `;
            }
        }

        // Convert lat/lon to tile coordinates using Leaflet's method
        function getTileRange(bounds, zoom) {
            const tileSize = 256;
            const pixelOrigin = L.point(0, 0);
            const mapMin = map.project(bounds.getNorthWest(), zoom);
            const mapMax = map.project(bounds.getSouthEast(), zoom);

            const minX = Math.floor(mapMin.x / tileSize);
            const maxX = Math.floor((mapMax.x - 1) / tileSize);
            const minY = Math.floor(mapMax.y / tileSize);
            const maxY = Math.floor((mapMin.y - 1) / tileSize);

            return {
                xMin: Math.max(0, minX),
                xMax: Math.max(0, maxX),
                yMin: Math.max(0, minY),
                yMax: Math.max(0, maxY)
            };
        }

        // Get tile URL using Leaflet's tile layer format
        function getTileUrl(source, x, y, zoom) {
            // Use Leaflet's built-in tile URL templates
            const tileLayers = {
                esri: L.tileLayer(`https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}`),
                osm: L.tileLayer(`https://tile.openstreetmap.org/{z}/{x}/{y}.png`)
            };

            const layer = tileLayers[source] || tileLayers.esri;
            const tileUrl = layer.getTileUrl({ x, y, z: zoom });
            return tileUrl;
        }

        // Browser-based download
        async function browserDownload() {
            if (!currentBBox) return;

            const source = document.getElementById('sourceSelect').value;
            const dataSource = DATA_SOURCES[source];

            if (!dataSource.available) {
                alert('æ­¤æ•°æ®æºæš‚ä¸å¯ç”¨ï¼Œè¯·é€‰æ‹© Esri æˆ– OSM');
                return;
            }

            const zoomInput = document.getElementById('zoomInput').value;
            const zoom = zoomInput ? parseInt(zoomInput) : (source === 'esri' ? 17 : 15);

            // Get tile range using Leaflet's method
            const bounds = L.latLngBounds(
                [currentBBox.min_lat, currentBBox.min_lon],
                [currentBBox.max_lat, currentBBox.max_lon]
            );
            const tileRange = getTileRange(bounds, zoom);
            const { xMin, xMax, yMin, yMax } = tileRange;

            const tileCount = (xMax - xMin + 1) * (yMax - yMin + 1);

            // Limit tile count
            if (tileCount > 400) {
                if (!confirm(`éœ€è¦ä¸‹è½½ ${tileCount} ä¸ªç“¦ç‰‡ï¼Œè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                    return;
                }
            }

            // Show progress
            const resultPanel = document.getElementById('resultPanel');
            const resultTitle = document.getElementById('resultTitle');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const downloadComplete = document.getElementById('downloadComplete');

            resultPanel.classList.add('show');
            resultTitle.textContent = 'ğŸ“¥ ä¸‹è½½ä¸­... | Downloading...';
            downloadComplete.style.display = 'none';
            document.getElementById('downloadProgress').style.display = 'block';

            // Calculate canvas size
            const tileSize = 256;
            const width = (xMax - xMin + 1) * tileSize;
            const height = (yMax - yMin + 1) * tileSize;

            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // Download tiles
            let completed = 0;
            const tiles = [];

            for (let x = xMin; x <= xMax; x++) {
                for (let y = yMin; y <= yMax; y++) {
                    tiles.push({ x, y });
                }
            }

            // Download with concurrency limit
            const concurrency = 6;
            for (let i = 0; i < tiles.length; i += concurrency) {
                const batch = tiles.slice(i, i + concurrency);
                await Promise.all(batch.map(async ({ x, y }) => {
                    try {
                        const url = getTileUrl(source, x, y, zoom);
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);

                        const blob = await response.blob();
                        const img = await createImageBitmap(blob);

                        const posX = (x - xMin) * tileSize;
                        const posY = (y - yMin) * tileSize;
                        ctx.drawImage(img, posX, posY);

                        completed++;
                        const progress = (completed / tileCount) * 100;
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `ä¸‹è½½ä¸­: ${completed}/${tileCount} (${Math.round(progress)}%)`;
                    } catch (e) {
                        console.warn(`Failed to load tile ${x}, ${y}:`, e);
                        completed++;
                    }
                }));
            }

            downloadedCanvas = canvas;

            // Convert to blob
            canvas.toBlob((blob) => {
                downloadedBlob = blob;

                // Update UI
                resultTitle.textContent = 'âœ… ä¸‹è½½å®Œæˆ! | Download Complete!';
                document.getElementById('downloadProgress').style.display = 'none';
                downloadComplete.style.display = 'block';

                // Show preview
                const previewImg = document.getElementById('previewImage');
                previewImg.src = URL.createObjectURL(blob);
                document.getElementById('imagePreviewBox').style.display = 'block';

                // Update info
                document.getElementById('resultSource').textContent = dataSource.name;
                document.getElementById('resultArea').textContent = `${currentBBox.min_lon.toFixed(4)}, ${currentBBox.min_lat.toFixed(4)} - ${currentBBox.max_lon.toFixed(4)}, ${currentBBox.max_lat.toFixed(4)}`;
                document.getElementById('resultTiles').textContent = `${tileCount} (${width}x${height}px)`;
                document.getElementById('resultResolution').textContent = `Zoom ${zoom}`;
            }, 'image/png');
        }

        // Save image
        function saveImage() {
            if (!downloadedBlob) return;

            const source = document.getElementById('sourceSelect').value;
            const bbox = `${currentBBox.min_lon.toFixed(4)}_${currentBBox.max_lon.toFixed(4)}_${currentBBox.min_lat.toFixed(4)}_${currentBBox.max_lat.toFixed(4)}`;

            const filename = `satellite_${source}_${bbox}.png`;

            const link = document.createElement('a');
            link.href = URL.createObjectURL(downloadedBlob);
            link.download = filename;
            link.click();
        }

        // Generate CLI command
        function generateCommand() {
            if (!currentBBox) return;

            const source = document.getElementById('sourceSelect').value;
            const zoom = document.getElementById('zoomInput').value;
            const compression = document.getElementById('compressionSelect').value;

            const bbox = `${currentBBox.min_lon},${currentBBox.min_lat},${currentBBox.max_lon},${currentBBox.max_lat}`;

            let cmd = `satellite-download --bbox ${bbox} --source ${source}`;
            if (zoom) cmd += ` --zoom ${zoom}`;
            if (compression != 'lzw') cmd += ` --compression ${compression}`;
            cmd += ` --output area_${source}.tif`;

            // Show command panel
            const resultPanel = document.getElementById('resultPanel');
            const resultTitle = document.getElementById('resultTitle');
            const downloadComplete = document.getElementById('downloadComplete');
            const commandBox = document.getElementById('commandBox');

            resultPanel.classList.add('show');
            resultTitle.textContent = 'ğŸ“‹ å‘½ä»¤è¡Œ | CLI Command';
            document.getElementById('downloadProgress').style.display = 'none';
            downloadComplete.style.display = 'block';
            document.getElementById('imagePreviewBox').style.display = 'none';
            commandBox.style.display = 'block';

            document.getElementById('commandOutput').textContent = cmd;
            document.getElementById('resultSource').textContent = DATA_SOURCES[source].name;
            document.getElementById('resultArea').textContent = bbox;
            document.getElementById('resultTiles').textContent = '-';
            document.getElementById('resultResolution').textContent = zoom || 'Auto';
        }

        function copyCommand() {
            const command = document.getElementById('commandOutput').textContent;
            navigator.clipboard.writeText(command).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => {
                    btn.textContent = 'å¤åˆ¶ | Copy';
                }, 2000);
            });
        }

        function clearSelection() {
            drawnItems.clearLayers();
            currentBBox = null;
            updateBBoxDisplay();
            updateDownloadButton();
            document.getElementById('resultPanel').classList.remove('show');
            downloadedCanvas = null;
            downloadedBlob = null;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            updateSourceInfo();

            document.getElementById('sourceSelect').addEventListener('change', updateSourceInfo);
            document.getElementById('downloadBtn').addEventListener('click', browserDownload);
            document.getElementById('commandBtn').addEventListener('click', generateCommand);
            document.getElementById('copyBtn').addEventListener('click', copyCommand);
            document.getElementById('clearBtn').addEventListener('click', clearSelection);
            document.getElementById('saveImageBtn').addEventListener('click', saveImage);
        });
    </script>
</body>
</html>
