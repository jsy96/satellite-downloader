# 更新日志

## 1.0.1 - 2026-01-30

### Bug 修复

#### 1. 类型注解错误
- **文件**: `satellite_downloader/geotiff.py`
- **问题**: `List[Tuple, int, int]` 语法错误，`List` 只接受一个类型参数
- **修复**: 改为 `List[Tuple[Any, int, int]]`
- **位置**: 第 58, 133, 317 行

#### 2. 瓦片生成循环错误
- **文件**: `satellite_downloader/tiles.py`
- **问题**: 在 Web Mercator 瓦片坐标系统中，Y 轴向下增加（屏幕坐标）。使用 `range(y_min, y_max + 1)` 在 `y_min > y_max` 时返回空列表
- **修复**: 改为 `range(y_max, y_min + 1)`
- **位置**: `get_tiles_in_bbox` 函数，第 157 行

#### 3. 画布尺寸计算错误
- **文件**: `satellite_downloader/geotiff.py`
- **问题**: 使用 `y_max - y_min + 1` 计算高度时得到负数
- **修复**: 改为 `y_min - y_max + 1`
- **位置**: `_merge_tiles` 和 `create_geotiff_tiled` 方法，第 78, 232 行

#### 4. 瓦片位置计算错误
- **文件**: `satellite_downloader/geotiff.py`
- **问题**: Y 位置计算引用 `y_min` 导致负数索引，部分瓦片无法放置
- **修复**: 改为从 `y_max`（顶部）开始引用
- **位置**: `_merge_tiles` 和 `_write_chunk` 方法，第 99, 311 行

#### 5. 地理边界计算错误（导致图像颠倒）
- **文件**: `satellite_downloader/geotiff.py`
- **问题**:
  - 在瓦片坐标中，`y_max` 是顶部（较小值），`y_min` 是底部（较大值）
  - 但代码错误地用 `y_min` 计算顶部边界，用 `y_max` 计算底部边界
  - 导致 `bottom > top`，GeoTIFF 图像上下颠倒
- **修复**: 交换 `y_max` 和 `y_min` 的使用
  - `left, top = tile_to_lonlat(x_min, y_max, zoom)`
  - `right, bottom = tile_to_lonlat(x_max + 1, y_min + 1, zoom)`
- **位置**: `_calculate_bounds` 方法，第 131-132 行

### 技术说明

#### 瓦片坐标系统
Google Maps/Earth 使用的 Web Mercator 投影瓦片系统：
- X 轴：从西向东增加（0 到 2^zoom - 1）
- Y 轴：从北向南增加（0 到 2^zoom - 1）
- 与屏幕坐标系统一致（原点在左上角，Y 向下增加）

#### 地理坐标系统
- 经度：-180° 到 180°，从西向东增加
- 纬度：-85.0511° 到 85.0511°，从南向北增加
- 与地理习惯一致（数值越大越靠北）

#### 坐标转换注意事项
1. `lonlat_to_tile(min_lon, max_lat, zoom)` → 返回 `(x_min, y_max)`
   - `y_max` 是顶部瓦片（较小的 Y 值）
2. `lonlat_to_tile(max_lon, min_lat, zoom)` → 返回 `(x_max, y_min)`
   - `y_min` 是底部瓦片（较大的 Y 值）
3. 因此在瓦片坐标中始终满足：`y_max <= y_min`

---

## 1.0.0 - 初始版本

初始功能发布：Google 卫星图像下载工具
- 支持 bbox 和 extent 格式的区域定义
- 自动缩放级别计算或手动指定
- 并发下载支持
- 缓存和断点续传
- GeoTIFF 和 BigTIFF 输出
